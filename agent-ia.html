<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant ISOTUILES v1.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="./styles.css">
    
</head>

<body>
    <div class="chat-container">
        <div class="chat-header">Assistant ISOTUILES</div>
        <div class="chat-box" id="chat-box">
            <div class="message bot-message">Bonjour, je suis lâ€™assistant ISOTUILES. Je peux vous renseigner sur nos
                panneaux imitation tuiles et vous aider Ã  crÃ©er un devis sur mesure. Comment puis-je vous aider
                aujourdâ€™hui ?</div>
            <div id="typing-indicator" style="display:none;">Agent Isotuiles Ã©crit...</div>
        </div>
        <div class="chat-input">
            <input type="text" id="user-input" placeholder="Ã‰crivez votre message...">
            <button id="send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-send-icon lucide-send">
                    <path
                        d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z" />
                    <path d="m21.854 2.147-10.94 10.939" />
                </svg>
            </button>
        </div>
    </div>
    <div id="quick-questions">
        <button id="slideToggleBtn"
            onclick="$('#quick-questions').toggleClass('expand');$('#quick-questions .btn_container').slideToggle()">
            Questions frÃ©quentes <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-chevron-down-icon lucide-chevron-down">
                <path d="m6 9 6 6 6-6" />
            </svg>
        </button>
        <div class="btn_container">
            <button class="quick-btn">Quels modÃ¨les proposez-vous ?</button>
            <button class="quick-btn">Quels sont vos dÃ©lais de livraison ?</button>
            <button class="quick-btn">Peut-on poser soi-mÃªme les panneaux ?</button>
        </div>
    </div>
    <div id="product-suggestions"></div>




    <button id="download-chat" class="btn" onclick="downloadChat()">ðŸ’¾ Sauvegarder la conversation</button>

    <div id="form-area"></div>

    <button class="btn" id="download-devis" onclick="generateDevis()">ðŸ“„ TÃ©lÃ©charger le devis</button>


    <script>



        // Fonction effet de frappe
        // Effet de frappe compatible avec du HTML (Markdown converti)
        function typeWriterHTML(element, html, callback) {
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = html;
            const nodes = Array.from(tempDiv.childNodes);
            let index = 0;

            function typeNextNode() {
                if (index < nodes.length) {
                    const node = nodes[index];
                    element.appendChild(node.cloneNode(true));
                    index++;
                    const delay = 20 + Math.random() * 40;
                    setTimeout(typeNextNode, delay);
                } else if (callback) {
                    callback();
                }
            }

            typeNextNode();
        }




        function appendMessage(content, sender = 'bot') {
            const msgClass = sender === 'user' ? 'user-message' : 'bot-message';
            const msgElement = $('<div>').addClass('message').addClass(msgClass);
            $('#chat-box').append(msgElement);

            // Enregistrement dans la mÃ©moire de conversation
            conversation.push({ role: sender === 'user' ? 'user' : 'assistant', content });

            if (sender === 'bot') {
                $("#typing-indicator").show();

                // Conversion du Markdown en HTML avant l'effet de frappe
                const safeHTML = DOMPurify.sanitize(marked.parse(content));

                // Effet de frappe progressif sur le HTML
                setTimeout(() => {
                    typeWriterHTML(msgElement[0], safeHTML, () => {
                        $("#typing-indicator").hide();
                        $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                    });
                }, 500 + Math.random() * 500);
            } else {
                msgElement.text(content);
                $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
            }
        }



        async function sendToOpenAI(message) {
            const systemPrompt = `Tu es ISOTUILES, un assistant commercial professionnel spÃ©cialisÃ© dans la vente de panneaux sandwich isolants imitation tuiles. Ton ton est avenant, clair et efficace. Tu poses les bonnes questions pour accompagner le client jusquâ€™Ã  la gÃ©nÃ©ration dâ€™un devis (dimensions, modÃ¨le, couleur, Ã©paisseur, charpente, accessoires, coordonnÃ©es). Lorsque tu as toutes les informations, tu annonces que le devis peut Ãªtre transmis Ã  isotuiles@gmail.com.`;
            const body = {
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: message }
                ]
            };
            $("#typing-indicator").show();
            const res = await fetch("https://agent-isotuiles.vercel.app/api/openai", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    // si tu as configurÃ© le client secret cÃ´tÃ© Vercel :
                    // "x-client-secret": "VALEUR_DE_TON_CLIENT_SECRET"
                },
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                const err = await res.json().catch(() => ({ error: res.statusText }));
                throw new Error(err?.message || `HTTP ${res.status}`);
            }
            $("#typing-indicator").hide();

            const data = await res.json();
            // Le format dÃ©pend de la version du SDK :
            // - si chat.completions.create : data.choices[0].message.content
            // - sinon adapter selon le JSON retournÃ©
            const content = data?.choices?.[0]?.message?.content || JSON.stringify(data);
            return content;
        }


        $('#send-btn').on('click', async function () {
            const userInput = $('#user-input').val().trim();
            if (!userInput) return;
            appendMessage(userInput, 'user');
            $('#user-input').val('');

            const botReply = await sendToOpenAI(userInput);
            appendMessage(botReply, 'bot');
        });

        $('#user-input').keypress(function (e) {
            if (e.which === 13) $('#send-btn').click();
        });

        $(".quick-btn").on("click", async function () {
            const question = $(this).text();

            // Ajout du message utilisateur
            appendMessage(question, 'user');

            // Envoi Ã  l'API OpenAI
            const botReply = await sendToOpenAI(question);

            // Affichage de la rÃ©ponse
            appendMessage(botReply, 'bot');
        });


        // Tableau global pour stocker toute la conversation
        let conversation = [];

        function downloadChat() {
            if (!conversation.length) {
                alert("Aucune conversation Ã  sauvegarder.");
                return;
            }

            const text = conversation
                .map(m => `${m.role === 'user' ? 'Client' : 'Isotuiles'} : ${m.content}`)
                .join("\n\n");

            const blob = new Blob([text], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `conversation-isotuiles-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }


        let clientData = {
            modele: null,
            longueur: null,
            largeur: null,
            couleur: null,
            accessoires: []
        };

        function processAIResponse(message) {
            if (message.includes("modÃ¨le")) askFor("modele");
            else if (message.includes("longueur")) askFor("longueur");
            else if (message.includes("largeur")) askFor("largeur");
            else if (message.includes("couleur")) askFor("couleur");
            else if (message.includes("accessoires")) askFor("accessoires");
        }

        function askFor(field) {
            // Afficher le champ dynamique
            $("#form-area").html(`<input id="input-${field}" placeholder="Votre ${field}" />`);
        }

        function generateDevis() {
            const text = `
Devis Isotuiles
----------------
ModÃ¨le : ${clientData.modele}
Dimensions : ${clientData.longueur} x ${clientData.largeur}
Couleur : ${clientData.couleur}
Accessoires : ${clientData.accessoires.join(", ")}
----------------
Contactez un commercial Ã  isotuiles@gmail.com
  `;
            const blob = new Blob([text], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "devis-isotuiles.txt";
            a.click();
        }


        function detectProducts(reply) {
            const products = [];
            if (reply.includes("Romane Canal")) products.push({ name: "Romane Canal", url: "https://isotuiles.fr/romane-canal" });
            if (reply.includes("Tuiles Plates")) products.push({ name: "Tuiles Plates", url: "https://isotuiles.fr/tuiles-plates" });
            if (reply.includes("Bac Acier")) products.push({ name: "Bac Acier", url: "https://isotuiles.fr/bac-acier" });

            if (products.length) {
                $("#product-suggestions").html(
                    products.map(p => `<div><a href="${p.url}" target="_blank">${p.name}</a></div>`).join("")
                );
            }
        }


    </script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

</body>

</html>